<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lost & Found Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">

  <!-- ===== CACHE REFRESH ===== -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
/* ===== GENERAL STYLES ===== */
*{box-sizing:border-box;font-family:Inter,Segoe UI,Tahoma,sans-serif;margin:0;padding:0;}
body{background:#eef2f6;color:#1f2937;padding:20px;}

/* ===== LOGIN CARD ===== */
#login{display:flex;justify-content:center;align-items:center;height:100vh;}
.login-card{background:#fff;padding:30px;border-radius:14px;width:320px;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
.login-card input, .login-card button{width:100%;padding:12px;margin-top:10px;border-radius:10px;border:1px solid #d1d5db;}
button.primary{background:#2563eb;color:white;border:none;cursor:pointer;font-weight:600;}
button.primary:hover{background:#1e40af;}

/* ===== ADMIN PANEL ===== */
#admin{display:none;}
header{background:#0f172a;color:white;padding:22px;border-radius:14px;margin-bottom:20px;text-align:center;}
.container{display:grid;grid-template-columns:340px 1fr;gap:20px;}
.form{background:#fff;padding:20px;border-radius:14px;border:1px solid #e5e7eb;}
input,select,button{width:100%;padding:10px;margin-bottom:10px;border-radius:10px;border:1px solid #d1d5db;}
button.secondary{background:#e5e7eb;border:none;cursor:pointer;font-weight:600;}
button.primary{background:#2563eb;color:white;border:none;cursor:pointer;font-weight:600;}
button.primary:hover{background:#1e40af;}

/* ===== LISTS ===== */
.lists{display:grid;grid-template-columns:1fr 1fr;gap:15px;}
.list-box{background:#fff;padding:15px;border-radius:14px;border:1px solid #e5e7eb;}
li{background:#f9fafb;padding:12px;border-radius:12px;margin-bottom:10px;border-left:5px solid #2563eb;font-size:0.9rem;display:flex;gap:10px;align-items:flex-start;}
li.found{border-left-color:#16a34a;}
li img{width:60px;height:60px;border-radius:10px;flex-shrink:0;}
.badge{display:inline-block;padding:4px 8px;font-size:0.7rem;border-radius:999px;margin-bottom:5px;}
.unclaimed{background:#fde68a;color:#92400e;}
.claimed{background:#bbf7d0;color:#065f46;}
.actions{display:flex;gap:6px;margin-top:8px;}
.edit{background:#fbbf24;border:none;color:white;padding:4px 6px;border-radius:6px;cursor:pointer;}
.delete{background:#dc2626;color:white;border:none;padding:4px 6px;border-radius:6px;cursor:pointer;}
.claim{background:#16a34a;color:white;border:none;padding:4px 6px;border-radius:6px;cursor:pointer;}

@media(max-width:900px){.container,.lists{grid-template-columns:1fr;}}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <div class="login-card">
    <h2>Admin Login</h2>
    <input type="password" id="pin" placeholder="Enter Admin PIN">
    <button class="primary" onclick="login()">Login</button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="admin">
  <header>
    <h1>Lost & Found Admin Panel</h1>
    <p>Municipal / Campus Management System</p>
  </header>

  <div class="container">
    <!-- FORM -->
    <div class="form">
      <h3>Add / Edit Item</h3>
      <select id="type">
        <option value="lost">Lost</option>
        <option value="found">Found</option>
      </select>
      <input id="item" placeholder="Item name">
      <input id="location" placeholder="Location">
      <input id="name" placeholder="Contact name">
      <input id="contact" placeholder="Contact">
      <input type="file" id="photo" accept="image/*" capture="environment">
      <img id="preview" style="display:none;width:80px;height:80px;margin-bottom:10px;">
      <input id="date" type="date">
      <input id="time" type="time">
      <button class="primary" onclick="addItem()">Save</button>
      <button class="secondary" onclick="clearForm()">Cancel</button>
      <hr>
      <button onclick="exportCSV()">Export CSV</button>
      <button onclick="window.print()">Print / PDF</button>
    </div>

    <!-- LISTS -->
    <div>
      <input id="search" placeholder="Search..." oninput="renderLists()">
      <div class="lists">
        <div class="list-box">
          <h3>Lost Items</h3>
          <ul id="lostList"></ul>
        </div>
        <div class="list-box">
          <h3>Found Items</h3>
          <ul id="foundList"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ===== VARIABLES =====
const ADMIN_PIN = "1234";
let lostItems = JSON.parse(localStorage.getItem("lostItems")) || [];
let foundItems = JSON.parse(localStorage.getItem("foundItems")) || [];
let editIndex = -1;

// ===== ELEMENTS =====
const loginDiv = document.getElementById("login");
const adminDiv = document.getElementById("admin");
const photoInput = document.getElementById("photo");
const preview = document.getElementById("preview");
const typeSelect = document.getElementById("type");
const itemInput = document.getElementById("item");
const locationInput = document.getElementById("location");
const nameInput = document.getElementById("name");
const contactInput = document.getElementById("contact");
const dateInput = document.getElementById("date");
const timeInput = document.getElementById("time");
const searchInput = document.getElementById("search");
const lostList = document.getElementById("lostList");
const foundList = document.getElementById("foundList");

// ===== LOGIN =====
function login() {
  if (document.getElementById("pin").value === ADMIN_PIN) {
    loginDiv.style.display = "none";
    adminDiv.style.display = "block";
    renderLists();
  } else alert("Invalid PIN");
}

// ===== PHOTO PREVIEW =====
photoInput.addEventListener("change", () => {
  const file = photoInput.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    preview.src = reader.result;
    preview.style.display = "block";
  };
  reader.readAsDataURL(file);
});

// ===== ADD / EDIT ITEM =====
function addItem() {
  const list = typeSelect.value === "lost" ? lostItems : foundItems;
  const now = new Date();

  const entry = {
    item: itemInput.value.trim() || "",
    location: locationInput.value.trim() || "",
    name: nameInput.value.trim() || "",
    contact: contactInput.value.trim() || "",
    photo: preview.src || "",
    date: dateInput.value || now.toLocaleDateString(),
    time: timeInput.value || now.toLocaleTimeString(),
    status: "Unclaimed"
  };

  if (editIndex > -1) {
    entry.status = list[editIndex].status; // preserve status when editing
    list[editIndex] = entry;
    editIndex = -1;
  } else {
    list.push(entry);
  }

  save();
}

// ===== RENDER LISTS =====
function renderLists() {
  lostList.innerHTML = "";
  foundList.innerHTML = "";
  const q = (searchInput.value || "").toLowerCase();

  lostItems.filter(i => (i.item || "").toLowerCase().includes(q))
           .forEach((i, idx) => lostList.innerHTML += itemCard(i, "lost", idx));

  foundItems.filter(i => (i.item || "").toLowerCase().includes(q))
            .forEach((i, idx) => foundList.innerHTML += itemCard(i, "found", idx));
}

// ===== ITEM CARD HTML =====
function itemCard(i, type, idx) {
  return `<li class="${type}">
    <img src="${i.photo || ''}">
    <div>
      <span class="badge ${i.status === "Claimed" ? "claimed" : "unclaimed"}">
        ${i.status || "Unclaimed"}
      </span><br>
      <strong>${i.item || ""}</strong><br>
      ${i.location || ""}<br>
      ${i.name || ""} ${i.contact ? "â€“ " + i.contact : ""}<br>
      ${i.date ? i.date : ""}${i.time ? ", " + i.time : ""}
      <div class="actions">
        <button class="edit" onclick="editItem('${type}', ${idx})">Edit</button>
        <button class="claim" onclick="toggleStatus('${type}', ${idx})">Claim</button>
        <button class="delete" onclick="deleteItem('${type}', ${idx})">Delete</button>
      </div>
    </div>
  </li>`;
}

// ===== ACTIONS =====
function editItem(type, idx) {
  const list = type === "lost" ? lostItems : foundItems;
  const i = list[idx];
  typeSelect.value = type;
  itemInput.value = i.item || "";
  locationInput.value = i.location || "";
  nameInput.value = i.name || "";
  contactInput.value = i.contact || "";
  dateInput.value = i.date || "";
  timeInput.value = i.time || "";
  preview.src = i.photo || "";
  preview.style.display = i.photo ? "block" : "none";
  editIndex = idx;
}

function toggleStatus(type, idx) {
  const list = type === "lost" ? lostItems : foundItems;
  list[idx].status = list[idx].status === "Claimed" ? "Unclaimed" : "Claimed";
  save();
}

function deleteItem(type, idx) {
  const list = type === "lost" ? lostItems : foundItems;
  list.splice(idx, 1);
  save();
}

function clearForm() {
  itemInput.value = locationInput.value = nameInput.value = contactInput.value = dateInput.value = timeInput.value = "";
  preview.src = "";
  preview.style.display = "none";
  editIndex = -1;
}

// ===== SAVE TO LOCALSTORAGE =====
function save() {
  localStorage.setItem("lostItems", JSON.stringify(lostItems));
  localStorage.setItem("foundItems", JSON.stringify(foundItems));
  clearForm();
  renderLists();
}

// ===== EXPORT CSV =====
function exportCSV() {
  let rows = [["Type","Item","Location","Name","Contact","Date","Time","Status","Photo"]];
  lostItems.forEach(i => rows.push(["Lost", i.item, i.location, i.name, i.contact, i.date, i.time, i.status, i.photo]));
  foundItems.forEach(i => rows.push(["Found", i.item, i.location, i.name, i.contact, i.date, i.time, i.status, i.photo]));
  const csv = rows.map(r => r.join(",")).join("\n");
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], {type: "text/csv"}));
  a.download = "lost_found_report.csv";
  a.click();
}

// ===== REAL-TIME SYNC =====
window.addEventListener('storage', () => {
  lostItems = JSON.parse(localStorage.getItem("lostItems")) || [];
  foundItems = JSON.parse(localStorage.getItem("foundItems")) || [];
  renderLists();
});

// ===== REGISTER SERVICE WORKER =====
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(() => console.log('Service Worker Registered'))
  .catch(err => console.log(err));
}

// ===== INITIAL RENDER =====
renderLists();
</script>
</body>
</html>
