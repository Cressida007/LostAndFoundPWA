<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lost & Found Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;font-family:Inter,Segoe UI,Tahoma,sans-serif;margin:0;padding:0;}
body{background:#eef2f6;color:#1f2937;padding:20px;}
#login{display:flex;justify-content:center;align-items:center;height:100vh;}
.login-card{background:#fff;padding:30px;border-radius:14px;width:320px;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
.login-card input, .login-card button{width:100%;padding:12px;margin-top:10px;border-radius:10px;border:1px solid #d1d5db;}
button.primary{background:#2563eb;color:white;border:none;cursor:pointer;font-weight:600;}
button.primary:hover{background:#1e40af;}
#admin{display:none;}
header{background:#0f172a;color:white;padding:22px;border-radius:14px;margin-bottom:20px;text-align:center;}
.container{display:grid;grid-template-columns:340px 1fr;gap:20px;}
.form{background:#fff;padding:20px;border-radius:14px;border:1px solid #e5e7eb;}
input,select,button{width:100%;padding:10px;margin-bottom:10px;border-radius:10px;border:1px solid #d1d5db;}
button.secondary{background:#e5e7eb;border:none;cursor:pointer;font-weight:600;}
.lists{display:grid;grid-template-columns:1fr 1fr;gap:15px;}
.list-box{background:#fff;padding:15px;border-radius:14px;border:1px solid #e5e7eb;}
li{background:#f9fafb;padding:12px;border-radius:12px;margin-bottom:10px;border-left:5px solid #2563eb;font-size:0.9rem;display:flex;gap:10px;align-items:flex-start;}
li.found{border-left-color:#16a34a;}
li.pet{border-left-color:#d63e00;background:#fff3f0;}
li img{width:60px;height:60px;border-radius:10px;flex-shrink:0;}
.badge{display:inline-block;padding:4px 8px;font-size:0.7rem;border-radius:999px;margin-bottom:5px;}
.unclaimed{background:#fde68a;color:#92400e;}
.claimed{background:#bbf7d0;color:#065f46;}
.actions{display:flex;gap:6px;margin-top:8px;}
.edit{background:#fbbf24;border:none;color:white;padding:4px 6px;border-radius:6px;cursor:pointer;}
.delete{background:#dc2626;color:white;padding:4px 6px;border-radius:6px;cursor:pointer;}
.claim{background:#16a34a;color:white;border:none;border-radius:6px;padding:4px 6px;cursor:pointer;}
@media(max-width:900px){.container,.lists{grid-template-columns:1fr;}}

/* Toast Notification */
#toast {
  visibility: hidden;
  min-width: 220px;
  background-color: #2563eb;
  color: white;
  text-align: center;
  border-radius: 8px;
  padding: 12px;
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  font-weight: 600;
  z-index: 9999;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAfFTBbhdBAoAnl4IAiq3gjZ16lrKJHKy8",
  authDomain: "lostandfoundpwa.firebaseapp.com",
  projectId: "lostandfoundpwa"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ADMIN_PIN = "1234";
let editDocId = null;

const loginDiv = document.getElementById("login");
const adminDiv = document.getElementById("admin");
const typeSelect = document.getElementById("type");
const itemInput = document.getElementById("item");
const locationInput = document.getElementById("location");
const nameInput = document.getElementById("name");
const contactInput = document.getElementById("contact");
const photoInput = document.getElementById("photo");
const preview = document.getElementById("preview");
const lostList = document.getElementById("lostList");
const foundList = document.getElementById("foundList");
const dateInput = document.getElementById("date");
const timeInput = document.getElementById("time");
const searchInput = document.getElementById("search");

// Toast function
function showToast(message="Upload finished!", duration=2500){
  const toast = document.getElementById("toast");
  toast.innerText = message;
  toast.style.visibility="visible";
  toast.style.opacity="1";
  setTimeout(()=>{
    toast.style.transition="opacity 0.5s ease-out";
    toast.style.opacity="0";
    setTimeout(()=>{toast.style.visibility="hidden"; toast.style.transition="";},500);
  },duration);
}

window.login = () => {
  if(document.getElementById("pin").value === ADMIN_PIN){
    loginDiv.style.display = "none";
    adminDiv.style.display = "block";
  } else alert("Invalid PIN");
};

// Resize image before Base64
async function getBase64Image(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const maxWidth = 800;
        const scale = Math.min(maxWidth/img.width,1);
        const canvas = document.createElement("canvas");
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        resolve(canvas.toDataURL("image/jpeg",0.8));
      };
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

photoInput.addEventListener("change", async ()=>{
  if(photoInput.files[0]){
    preview.src = await getBase64Image(photoInput.files[0]);
    preview.style.display="block";
  }
});

window.addItem = async ()=>{
  if(!itemInput.value.trim()||!locationInput.value.trim()){alert("Please fill item and location"); return;}
  const now = new Date();
  const photoBase64 = preview.src || "";

  const entry = {
    type: typeSelect.value,
    item: itemInput.value.trim(),
    location: locationInput.value.trim(),
    name: nameInput.value.trim(),
    contact: contactInput.value.trim(),
    photo: photoBase64,
    date: dateInput.value || now.toISOString().split("T")[0],
    time: timeInput.value || now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
    status: "Unclaimed"
  };

  try{
    if(editDocId){
      await updateDoc(doc(db,"lostAndFound",editDocId),entry);
      editDocId=null;
      showToast("Item updated!");
    } else {
      await addDoc(collection(db,"lostAndFound"),entry);
      showToast("Upload finished!");
    }
    clearForm();
  } catch(e){console.error(e); alert("Failed to save item");}
};

function clearForm(){
  itemInput.value=locationInput.value=nameInput.value=contactInput.value=dateInput.value=timeInput.value="";
  preview.src=""; preview.style.display="none"; editDocId=null; photoInput.value=null;
}

function renderLists(){
  onSnapshot(collection(db,"lostAndFound"), snapshot=>{
    lostList.innerHTML=""; foundList.innerHTML="";
    snapshot.docs.forEach(docSnap=>{
      const i = docSnap.data();
      const li = document.createElement("li");
      li.className = i.type==="found"?"found":(i.type==="pet"?"pet":"");
      const petIcon = i.type==="pet"?`<img src="https://cdn-icons-png.flaticon.com/512/3460/3460335.png" class="pet-icon" alt="Pet">`:"";
      const imgSrc = i.photo || "";

      li.innerHTML = `${petIcon}<img src="${imgSrc}"><div>
        <span class="badge ${i.status==="Claimed"?"claimed":"unclaimed"}">${i.status}</span><br>
        <strong>${i.item}</strong><br>
        ${i.location}<br>
        ${i.name} ${i.contact?"â€“ "+i.contact:""}<br>
        ${i.date}${i.time?", "+i.time:""}
        <div class="actions">
          <button class="edit" onclick="editItem('${docSnap.id}')">Edit</button>
          <button class="claim" onclick="toggleStatus('${docSnap.id}')">Claim</button>
          <button class="delete" onclick="deleteItem('${docSnap.id}')">Delete</button>
        </div>
      </div>`;

      if(i.status==="Claimed" || i.type==="found") foundList.appendChild(li);
      else lostList.appendChild(li);
    });
  });
}

window.editItem = async docId=>{
  const snapshot = await getDoc(doc(db,"lostAndFound",docId));
  if(!snapshot.exists()) return;
  const i = snapshot.data();
  typeSelect.value=i.type;
  itemInput.value=i.item;
  locationInput.value=i.location;
  nameInput.value=i.name;
  contactInput.value=i.contact;
  dateInput.value=i.date;
  timeInput.value=i.time;
  preview.src=i.photo||"";
  preview.style.display=i.photo?"block":"none";
  editDocId=docId;
};

window.toggleStatus = async docId=>{
  const d = doc(db,"lostAndFound",docId);
  const snapshot = await getDoc(d);
  if(!snapshot.exists()) return;
  const i = snapshot.data();
  const newStatus = i.status==="Claimed"?"Unclaimed":"Claimed";
  await updateDoc(d,{status:newStatus});
  if(newStatus==="Claimed") showToast("Item marked as claimed!");
};

window.deleteItem = async docId=>{
  if(confirm("Are you sure you want to delete this item?")) await deleteDoc(doc(db,"lostAndFound",docId));
};

searchInput.addEventListener("input", renderLists);
renderLists();
</script>
</head>
<body>
<div id="login">
  <div class="login-card">
    <h2>Admin Login</h2>
    <input type="password" id="pin" placeholder="Enter Admin PIN">
    <button type="button" class="primary" onclick="login()">Login</button>
  </div>
</div>

<div id="admin">
<header>
  <h1>Lost & Found Admin Panel</h1>
  <p>Municipal / Campus Management System</p>
</header>

<div class="container">
<div class="form">
  <h3>Add / Edit Item</h3>
  <select id="type">
    <option value="lost">Lost</option>
    <option value="found">Found</option>
    <option value="pet">Pet</option>
  </select>
  <input id="item" placeholder="Item name">
  <input id="location" placeholder="Location">
  <input id="name" placeholder="Contact name">
  <input id="contact" placeholder="Contact">
  <input type="file" id="photo" accept="image/*">
  <img id="preview" style="display:none;width:80px;height:80px;margin-bottom:10px;">
  <input id="date" type="date">
  <input id="time" type="time">
  <button class="primary" onclick="addItem()">Save</button>
  <button class="secondary" onclick="clearForm()">Cancel</button>
  <hr>
</div>

<div>
<input id="search" placeholder="Search..." oninput="renderLists()">
<div class="lists">
  <div class="list-box"><h3>Lost Items</h3><ul id="lostList"></ul></div>
  <div class="list-box"><h3>Found Items</h3><ul id="foundList"></ul></div>
</div>
</div>
</div>
</div>

<!-- Toast -->
<div id="toast"></div>

</body>
</html>
